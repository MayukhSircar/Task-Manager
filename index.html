<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Campus - Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .form-input { transition: all 0.3s ease; }
        .form-input:focus { box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5); border-color: #60a5fa; }
        .btn-primary { background-color: #3b82f6; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #2563eb; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); }
        /* Dark Mode Styles */
        .dark { background-color: #111827; color: #d1d5db; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .text-gray-900 { color: #f9fafb; }
        .dark .text-gray-800 { color: #d1d5db; }
        .dark .text-gray-700 { color: #9ca3af; }
        .dark .text-gray-600 { color: #9ca3af; }
        .dark .text-gray-500 { color: #6b7280; }
        .dark .border-gray-300 { border-color: #4b5563; }
        .dark .shadow-lg, .dark .shadow-md, .dark .shadow-sm { box-shadow: 0 0 #0000, 0 0 #0000, 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.2); }
        .dark .bg-gray-100 { background-color: #111827; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .bg-gray-300 { background-color: #4b5563; }
        .dark .hover\:bg-gray-400:hover { background-color: #6b7280; }
        .dark .hover\:bg-gray-50:hover { background-color: #374151; }
        
        /* Spinner Animation */
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Auth Section -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-900">Task Manager Login</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-700">Email</label>
                    <input id="login-email" type="email" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg form-input bg-gray-50 dark:bg-gray-800" placeholder="you@example.com">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="login-password" type="password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg form-input bg-gray-50 dark:bg-gray-800" placeholder="••••••••">
                </div>
                <p id="login-error" class="text-sm text-red-600"></p>
                <button type="submit" class="w-full py-3 px-4 text-white font-semibold rounded-lg btn-primary">Login</button>
            </form>
            <p class="text-sm text-center text-gray-600">
                Don't have an account? <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Main App Section (hidden by default) -->
    <div id="app-container" class="hidden min-h-screen">
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-2xl font-bold text-blue-600">Task Manager</h1>
                    <div class="flex items-center">
                        <!-- Dark Mode Toggle -->
                        <button id="dark-mode-toggle" class="mr-4 p-2 rounded-full text-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700">
                            <svg id="moon-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            <svg id="sun-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        </button>
                        <span id="user-email" class="text-gray-600 mr-4"></span>
                        <button id="logout-btn" class="text-sm font-medium text-red-600 hover:text-red-500">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold">Your Tasks</h2>
                    <button id="add-task-btn" class="w-full md:w-auto py-2 px-4 text-white font-semibold rounded-lg btn-primary flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add New Task
                    </button>
                </div>

                <!-- Filters & Search -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filter-priority" class="block text-sm font-medium text-gray-700">Filter by Priority</label>
                        <select id="filter-priority" class="w-full mt-1 border-gray-300 rounded-lg form-input">
                            <option value="All">All Priorities</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="sort-by" class="block text-sm font-medium text-gray-700">Sort By</label>
                        <select id="sort-by" class="w-full mt-1 border-gray-300 rounded-lg form-input">
                            <option value="createdAt-desc">Newest First</option>
                            <option value="createdAt-asc">Oldest First</option>
                            <option value="dueDate-asc">Due Date</option>
                            <option value="priority-desc">Priority (High to Low)</option>
                            <option value="priority-asc">Priority (Low to High)</option>
                        </select>
                    </div>
                     <div>
                        <label for="search-input" class="block text-sm font-medium text-gray-700">Search Tasks</label>
                        <input type="text" id="search-input" placeholder="Search by title..." class="w-full mt-1 border-gray-300 rounded-lg form-input">
                    </div>
                </div>

                <!-- Loading Spinner and Task List -->
                <div id="loading-spinner" class="hidden flex justify-center items-center py-10">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                </div>
                <div id="task-list" class="space-y-4"></div>
                
                <!-- Pagination -->
                <div id="pagination-controls" class="mt-6 flex justify-between items-center">
                    <button id="prev-page" class="py-2 px-4 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50" disabled>Previous</button>
                    <span id="page-info">Page 1</span>
                    <button id="next-page" class="py-2 px-4 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="task-modal" class="hidden fixed inset-0 z-10 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 transition-opacity modal-overlay"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full p-6 z-20">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mb-4">Add Task</h3>
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <div class="space-y-4">
                        <div>
                            <label for="task-title" class="block text-sm font-medium text-gray-700">Title (Text)</label>
                            <input type="text" id="task-title" required class="w-full mt-1 border-gray-300 rounded-lg form-input">
                        </div>
                        <div>
                            <label for="task-priority" class="block text-sm font-medium text-gray-700">Priority (Enum)</label>
                            <select id="task-priority" class="w-full mt-1 border-gray-300 rounded-lg form-input">
                                <option>Low</option>
                                <option>Medium</option>
                                <option>High</option>
                            </select>
                        </div>
                        <div>
                            <label for="task-due-date" class="block text-sm font-medium text-gray-700">Due Date</label>
                            <input type="date" id="task-due-date" required class="w-full mt-1 border-gray-300 rounded-lg form-input">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="task-completed" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="task-completed" class="ml-2 block text-sm text-gray-900">Completed (Boolean)</label>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="cancel-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" id="save-btn" class="btn-primary py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white">Save Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 z-20 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 transition-opacity modal-overlay"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-sm sm:w-full p-6 z-30">
                <h3 class="text-lg font-medium text-gray-900">Confirm Deletion</h3>
                <p class="mt-2 text-sm text-gray-600">Are you sure you want to delete this task? This action cannot be undone.</p>
                <div class="mt-4 flex justify-end space-x-3">
                    <button id="confirm-cancel" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button id="confirm-delete" class="bg-red-600 hover:bg-red-700 py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // IMPORTANT: Replace with your own Firebase project configuration!
        const firebaseConfig = {
  apiKey: "AIzaSyDo3Or1JOqEXdNWURT23S5tJU8hxJa1-B4",
  authDomain: "ai-campus-assignment.firebaseapp.com",
  projectId: "ai-campus-assignment",
  storageBucket: "ai-campus-assignment.firebasestorage.app",
  messagingSenderId: "1006850472823",
  appId: "1:1006850472823:web:7939a801008cec5afe7f72",
  measurementId: "G-7GWL8H211Z"
};

        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ... (Keep all UI element declarations, they are correct)
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const showSignupBtn = document.getElementById('show-signup');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const taskModal = document.getElementById('task-modal');
        const addTaskBtn = document.getElementById('add-task-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const taskForm = document.getElementById('task-form');
        const taskListDiv = document.getElementById('task-list');
        const modalTitle = document.getElementById('modal-title');
        const filterPriority = document.getElementById('filter-priority');
        const sortBy = document.getElementById('sort-by');
        const searchInput = document.getElementById('search-input');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const loadingSpinner = document.getElementById('loading-spinner');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmCancelBtn = document.getElementById('confirm-cancel');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        
        let currentUser = null;
        let lastVisibleTask = null;
        let currentPage = 1;
        const tasksPerPage = 5;
        let searchTimeout;

        // --- (Keep all helper functions: applyTheme, updatePaginationButtons, getPriorityColor, getPriorityBgColor, modals, createTaskElement) ---
        // These are correct. For brevity, I'm omitting them here but you should keep them in your code.
        const applyTheme = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        };

        const updatePaginationButtons = (fetchedCount) => {
            pageInfo.textContent = `Page ${currentPage}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = fetchedCount < tasksPerPage;
        };
        
        const getPriorityColor = (priority) => {
            if (priority === 'High') return 'border-red-500';
            if (priority === 'Medium') return 'border-yellow-500';
            return 'border-green-500';
        };

        const getPriorityBgColor = (priority) => {
            if (priority === 'High') return 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
            if (priority === 'Medium') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300';
            return 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
        };

        let taskToDeleteId = null;
        const openConfirmModal = (id) => {
            taskToDeleteId = id;
            confirmModal.classList.remove('hidden');
        };
        
        const closeConfirmModal = () => {
            taskToDeleteId = null;
            confirmModal.classList.add('hidden');
        };

        const openModal = (task = null) => {
            taskForm.reset();
            const taskIdInput = document.getElementById('task-id');
            if (task) {
                modalTitle.textContent = 'Edit Task';
                taskIdInput.value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-due-date').value = task.dueDate;
                document.getElementById('task-completed').checked = task.completed;
            } else {
                modalTitle.textContent = 'Add New Task';
                taskIdInput.value = '';
            }
            taskModal.classList.remove('hidden');
        };
        
        const closeModal = () => {
            taskModal.classList.add('hidden');
        };
        
        const createTaskElement = (task) => {
            const div = document.createElement('div');
            div.className = `bg-white p-4 rounded-lg shadow-sm border-l-4 ${getPriorityColor(task.priority)} transition-transform transform hover:scale-105`;
            
            const dueDate = new Date(task.dueDate);
            const now = new Date();
            dueDate.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            const diffTime = dueDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let timeUntilDueText = '';
            if (task.completed) {
                 timeUntilDueText = `<span class="text-green-600 font-medium">Completed</span>`;
            } else if (diffDays < 0) {
                timeUntilDueText = `<span class="text-red-600 font-medium">Overdue by ${Math.abs(diffDays)} days</span>`;
            } else if (diffDays === 0) {
                 timeUntilDueText = `<span class="text-yellow-600 font-medium">Due today</span>`;
            } else {
                timeUntilDueText = `<span class="text-gray-500">Due in ${diffDays} days</span>`;
            }

            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold text-lg ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</h4>
                        <p class="text-sm text-gray-500">Due: ${task.dueDate}</p>
                        <p class="text-sm mt-1">${timeUntilDueText}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                         <span class="text-sm font-medium px-2 py-1 rounded-full ${getPriorityBgColor(task.priority)}">${task.priority}</span>
                         <button data-id="${task.id}" class="edit-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button>
                         <button data-id="${task.id}" class="delete-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                </div>
            `;
            
            div.querySelector('.edit-btn').addEventListener('click', () => openModal(task));
            div.querySelector('.delete-btn').addEventListener('click', () => openConfirmModal(task.id));
            return div;
        };
        

        // --- CORE FETCH LOGIC (UPDATED) ---
        const fetchTasks = async (direction = 'next') => {
            if (!currentUser) return;
            
            loadingSpinner.classList.remove('hidden');
            taskListDiv.innerHTML = '';

            let queryConstraints = [];
            const tasksRef = collection(db, "users", currentUser.uid, "tasks");

            const selectedPriority = filterPriority.value;
            if (selectedPriority !== 'All') {
                queryConstraints.push(where("priority", "==", selectedPriority));
            }

            const searchTerm = searchInput.value.trim().toLowerCase();
            const sortValue = sortBy.value.split('-');
            const sortField = sortValue[0];
            const sortDirection = sortValue[1];
            
            // THIS IS THE NEW LOGIC
            if (searchTerm) {
                // When searching, the first orderBy MUST be on the search field
                queryConstraints.push(where('title_lowercase', '>=', searchTerm));
                queryConstraints.push(where('title_lowercase', '<=', searchTerm + '\uf8ff'));
                queryConstraints.push(orderBy('title_lowercase', 'asc'));
                
                // Add the user's selected sort as a secondary sort condition
                if (sortField !== 'title_lowercase') {
                    queryConstraints.push(orderBy(sortField, sortDirection));
                }
            } else {
                // If not searching, just use the selected sort field
                queryConstraints.push(orderBy(sortField, sortDirection));
            }
            // END OF NEW LOGIC

            if (direction === 'next' && lastVisibleTask) {
                queryConstraints.push(startAfter(lastVisibleTask));
            } else { 
                lastVisibleTask = null; 
                currentPage = 1;
            }
            queryConstraints.push(limit(tasksPerPage));
            
            const tasksQuery = query(tasksRef, ...queryConstraints);
            
            try {
                const querySnapshot = await getDocs(tasksQuery);
                if (querySnapshot.empty && currentPage === 1) {
                    taskListDiv.innerHTML = '<p class="text-gray-500 text-center">No tasks found. Add one!</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const task = { id: doc.id, ...doc.data() };
                        taskListDiv.appendChild(createTaskElement(task));
                    });
                }
                
                const docs = querySnapshot.docs;
                if (docs.length > 0) lastVisibleTask = docs[docs.length - 1];
                updatePaginationButtons(docs.length);

            } catch (error) {
                console.error("Error fetching tasks: ", error);
                taskListDiv.innerHTML = `<p class="text-red-500 text-center">Error fetching tasks. Firestore indexes might be required for this query. Check the console.</p>`;
            } finally {
                 loadingSpinner.classList.add('hidden');
            }
        };

        // --- (Keep all event listeners and initializers) ---
        // These are correct. For brevity, I'm omitting them here but you should keep them in your code.
        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            applyTheme(isDark);
        });
        
        if (localStorage.getItem('darkMode') === 'true') {
            applyTheme(true);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userEmailSpan.textContent = user.email;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                fetchTasks();
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                errorP.textContent = '';
            } catch (error) {
                errorP.textContent = error.message;
            }
        });
        
        showSignupBtn.addEventListener('click', async (e) => {
             e.preventDefault();
             const email = prompt("Enter your email for signup:");
             const password = prompt("Enter your password for signup:");
             if (email && password) {
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    alert('Signup successful! Please log in.');
                } catch(error) {
                    alert('Signup Error: ' + error.message);
                }
             }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        addTaskBtn.addEventListener('click', () => openModal());
        cancelBtn.addEventListener('click', closeModal);
        
        taskForm.onsubmit = async (e) => {
             e.preventDefault();
            if (!currentUser) return;

            const taskId = document.getElementById('task-id').value;
            const titleValue = document.getElementById('task-title').value;
            const taskData = {
                title: titleValue,
                title_lowercase: titleValue.toLowerCase(),
                priority: document.getElementById('task-priority').value,
                dueDate: document.getElementById('task-due-date').value,
                completed: document.getElementById('task-completed').checked,
                userId: currentUser.uid,
            };

            try {
                if (taskId) {
                    const taskRef = doc(db, "users", currentUser.uid, "tasks", taskId);
                    await updateDoc(taskRef, taskData);
                } else {
                    taskData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, "users", currentUser.uid, "tasks"), taskData);
                }
                closeModal();
                lastVisibleTask = null; currentPage = 1;
                fetchTasks();
            } catch (error) {
                console.error("Error saving task: ", error);
            }
        };
        
        confirmCancelBtn.addEventListener('click', closeConfirmModal);
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!currentUser || !taskToDeleteId) return;
            try {
                await deleteDoc(doc(db, "users", currentUser.uid, "tasks", taskToDeleteId));
                closeConfirmModal();
                lastVisibleTask = null; currentPage = 1;
                fetchTasks();
            } catch (error) {
                console.error("Error deleting task: ", error);
            }
        });

        const resetAndFetch = () => { lastVisibleTask = null; currentPage = 1; fetchTasks(); };
        filterPriority.addEventListener('change', resetAndFetch);
        sortBy.addEventListener('change', resetAndFetch);
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(resetAndFetch, 500); // Debouncing
        });

        nextPageBtn.addEventListener('click', () => { currentPage++; fetchTasks('next'); });
        prevPageBtn.addEventListener('click', () => {
             alert("Previous page functionality requires a more complex query. Please refilter or resort to reset to the first page.");
        });

    </script>
</body>
</html>



